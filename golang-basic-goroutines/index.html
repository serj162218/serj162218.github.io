<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Golang Basic - GoRoutines | AnnieMeow</title>
<meta name="description" content="A little cat who named &amp;lt;?=$name?&amp;gt; likes to &amp;lt;?=$hibit?&amp;gt;.">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://serj162218.github.io//favicon.ico?v=1684434780321">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://serj162218.github.io//styles/main.css">


<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
  
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://serj162218.github.io/">AnnieMeow</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="/" class="menu">
                Index
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                Archives
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>Golang Basic - GoRoutines</h1>
            <p class="article-meta">
              2023-05-10
              
                <a href="https://serj162218.github.io/tag/hl18hCdAP/" class="badge secondary">
                  Golang Basic
                </a>
              
            </p>
            
            <div class="post-content" v-pre>
              <p><a href="https://youtu.be/YS4e4q9oBaU?t=20037">reference source</a></p>
<h1 id="goroutines">GoRoutines</h1>
<p>Concurrent and Parallel</p>
<h2 id="creating-goroutines">Creating goroutines</h2>
<p>A simple example, time.Sleep is needed because main() ends too soon for the goroutines to print</p>
<pre><code class="language-java">func main() {
	go sayHello()
	time.Sleep(100 * time.Microsecond)
}
func sayHello() {
	fmt.Println(&quot;hello&quot;)
}

hello
</code></pre>
<p>Goroutines can also be used in anonymous functions, <code>msg</code> will use the nearest variable</p>
<pre><code class="language-java">func main() {
	var msg = &quot;Hello&quot;
	go func() {
		fmt.Println(msg)
	}()
	time.Sleep(100 * time.Microsecond)
}

Hello
</code></pre>
<h3 id="race-condition">Race condition</h3>
<p>The main function is executed too fast and the resource of msg is changed, so that goroutines will also be affected.</p>
<pre><code class="language-java">func main() {
	var msg = &quot;Hello&quot;
	go func() {
		fmt.Println(msg)
	}()
	msg = &quot;goodnight&quot;
	time.Sleep(100 * time.Microsecond)
}

goodnight
</code></pre>
<h2 id="synchronization">Synchronization</h2>
<h3 id="waitgroups">WaitGroups</h3>
<p>Basic usage, <code>wg.Done()</code> will automatically minus the counter with one, <code>wg.Add(1)</code> will add one to the counter, <code>wg.Wait()</code> will pause until the counter is zero</p>
<pre><code class="language-java">func main() {
	var msg = &quot;Hello&quot;
	wg.Add(1)
	go func() {
		fmt.Println(msg)
		wg.Done()
	}()
	wg.Wait()
	msg = &quot;goodnight&quot;
}
</code></pre>
<p>From the following example, although WaitGroup is useful, the execution is still a mess. The only improvement point is that the output is ordered.</p>
<pre><code class="language-java">var wg = sync.WaitGroup{}
var counter = 0

func main() {
	for i := 0; i &lt; 10; i++ {
		wg.Add(2)
		go sayHello()
		go increment()
	}
	wg.Wait()
}

func sayHello() {
	fmt.Println(counter)
	wg.Done()
}

func increment() {
	counter++
	wg.Done()
}

0
2
4
5
6
7
8
9
10
10
</code></pre>
<h3 id="mutexes-lock">Mutexes (Lock)</h3>
<p>Although the lock is added, because each thread is still executed, the result will still change.</p>
<pre><code class="language-java">var wg = sync.WaitGroup{}
var counter = 0
var m = sync.RWMutex{}

func main() {
	for i := 0; i &lt; 10; i++ {
		wg.Add(2)
		go sayHello()
		go increment()
	}
	wg.Wait()
}

func sayHello() {
	m.RLock()
	fmt.Println(counter)
	m.RUnlock()
	wg.Done()
}

func increment() {
	m.Lock()
	counter++
	m.Unlock()
	wg.Done()
}

0
1
1
1
1
1
1
1
1
1
</code></pre>
<p>After improvement, the results are finally in order.</p>
<pre><code class="language-java">var wg = sync.WaitGroup{}
var counter = 0
var m = sync.RWMutex{}

func main() {
	for i := 0; i &lt; 10; i++ {
		wg.Add(2)
		m.RLock()
		go sayHello()
		m.Lock()
		go increment()
	}
	wg.Wait()
}

func sayHello() {
	fmt.Println(counter)
	m.RUnlock()
	wg.Done()
}

func increment() {
	counter++
	m.Unlock()
	wg.Done()
}

0
1
2
3
4
5
6
7
8
9
</code></pre>
<p>This is an exercise purely as an example, not a good exercise, because the advantages of parallelism and concurrency are gone, and the execution speed and resources are even worse.</p>
<h3 id="runtimegomaxprocs"><code>runtime.GOMAXPROCS()</code></h3>
<pre><code class="language-java">func main() {
	fmt.Println(runtime.GOMAXPROCS(-1))
}

20
</code></pre>
<p><code>runtime.GOMAXPROCS(n)</code> is adjusted to use n threads, -1 means do not adjust and return the currently set thread nums</p>
<pre><code class="language-java">func main() {
	runtime.GOMAXPROCS(30)
	fmt.Println(runtime.GOMAXPROCS(-1))
}

30
</code></pre>
<p>If n = 1, it is a single thread</p>
<pre><code class="language-java">func main() {
	runtime.GOMAXPROCS(1)
	fmt.Println(runtime.GOMAXPROCS(-1))
}
</code></pre>
<p>Because it is a single thread, so everything is in order, after the above example is added, it will follow the order obediently. This purpose is to ensure the order is correct to avoid any race condition.</p>
<pre><code class="language-java">func main() {
	runtime.GOMAXPROCS(1)
	for i := 0; i &lt; 10; i++ {
		wg.Add(2)
		go sayHello()
		go increment()
	}
	wg.Wait()
}

func sayHello() {
	fmt.Println(counter)
	wg.Done()
}

func increment() {
	counter++
	wg.Done()
}

1
2
3
4
5
6
7
8
9
10
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<ul>
<li>Donâ€™t create goroutines in libraries
<ul>
<li>Let consumer control concurrency</li>
</ul>
</li>
<li>When creating a goroutine, know how it will end
<ul>
<li>Avoids subtle memory leaks</li>
</ul>
</li>
<li>Check for race conditions at compile time (need to use cgo, I did not open that.)</li>
</ul>

            </div>
          </article>
        </div>
        <div class="paper" data-aos="fade-in">
          
            <div class="next-post">
              <div class="next">
                Next &gt;
              </div>
              <a href="https://serj162218.github.io/golang-basic-function/">
                <h3 class="post-title">
                  Golang Basic - Function
                </h3>
              </a>
            </div>
          
        </div>
        
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img src="https://serj162218.github.io//images/avatar.png?v=1684434780321" class="no-responsive avatar">
    <div class="text-muted">A little cat who named &lt;?=$name?&gt; likes to &lt;?=$hibit?&gt;.</div>
    <div class="social-container">
      
        
          <a href="https://github.com/serj162218" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
      
        
      
        
      
        
      
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      Latest Article
    </div>
    <div class="row">
      <ul>
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-unit-test/">Golang Basic - Unit test</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-variables/">Golang Basic - Variables</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-struct/">Golang Basic - Struct</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-primitives/">Golang Basic - Primitives</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-pointers/">Golang Basic - Pointers</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-map/">Golang Basic - Map</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-interface/">Golang Basic - Interface</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-if-and-switch-statements/">Golang Basic - If and Switch Statements</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-goroutines/">Golang Basic - GoRoutines</a>
            </li>
          
        
          
            <li>
              <a href="https://serj162218.github.io/golang-basic-function/">Golang Basic - Function</a>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      Tags
    </div>
    <div class="row">
      
        <a href="https://serj162218.github.io/tag/hl18hCdAP/" class="badge secondary">
          Golang Basic
        </a>
      
        <a href="https://serj162218.github.io/tag/e2ksjSHDX/" class="badge ">
          sql
        </a>
      
        <a href="https://serj162218.github.io/tag/IPziRV_tR/" class="badge secondary">
          leetcode
        </a>
      
        <a href="https://serj162218.github.io/tag/fQfrV7sv2/" class="badge warning">
          javascript
        </a>
      
        <a href="https://serj162218.github.io/tag/gYy3vmfCl/" class="badge ">
          others
        </a>
      
        <a href="https://serj162218.github.io/tag/hevQ_ITqL/" class="badge secondary">
          Common used
        </a>
      
    </div>
  </div>
  <div class="paper">
    <h3>I'm wondering where's my fish, fish, fish for my dish, dish, dish.</h3></a>
  </div>
</div>


    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

</script>




  </body>
</html>
